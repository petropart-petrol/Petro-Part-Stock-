<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة المخزون - بتروبارت</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2c5aa0;
            --secondary: #1e3a8a;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --light: #f8fafc;
            --dark: #1e293b;
        }
        
        * {
            font-family: 'Tajawal', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--dark);
        }
        
        .app-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            margin: 20px auto;
            max-width: 1400px;
        }
        
        .app-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 25px 30px;
            border-radius: 0 0 20px 20px;
        }
        
        .app-logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .app-logo i {
            font-size: 2.5rem;
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 15px;
        }
        
        .exchange-rate-card {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            padding: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .stats-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s ease;
            border: none;
            height: 100%;
        }
        
        .stats-card:hover {
            transform: translateY(-5px);
        }
        
        .stats-card i {
            font-size: 2.5rem;
            margin-bottom: 15px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .stats-card .number {
            font-size: 2rem;
            font-weight: 700;
            margin: 10px 0;
        }
        
        .stats-card .label {
            color: #64748b;
            font-size: 0.9rem;
        }
        
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            margin-bottom: 25px;
            overflow: hidden;
        }
        
        .card-header {
            background: white;
            border-bottom: 1px solid #e2e8f0;
            padding: 20px 25px;
            font-weight: 700;
            font-size: 1.2rem;
            color: var(--primary);
        }
        
        .table th {
            background: #f1f5f9;
            color: var(--primary);
            font-weight: 600;
            border-top: none;
            padding: 15px;
        }
        
        .table td {
            padding: 15px;
            vertical-align: middle;
        }
        
        .btn {
            border-radius: 10px;
            padding: 10px 20px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border: none;
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
            border: none;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, var(--warning) 0%, #d97706 100%);
            border: none;
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
            border: none;
        }
        
        .btn-info {
            background: linear-gradient(135deg, var(--info) 0%, #2563eb 100%);
            border: none;
        }
        
        .btn-sm {
            padding: 8px 15px;
            font-size: 0.85rem;
        }
        
        .search-box {
            position: relative;
        }
        
        .search-box i {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #94a3b8;
        }
        
        .search-box input {
            padding-right: 45px;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .modal-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            border-bottom: none;
            border-radius: 15px 15px 0 0;
        }
        
        .modal-content {
            border: none;
            border-radius: 15px;
            overflow: hidden;
        }
        
        .form-control, .form-select {
            border-radius: 10px;
            padding: 12px 15px;
            border: 1px solid #e2e8f0;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 0.25rem rgba(44, 90, 160, 0.25);
        }
        
        .loading {
            text-align: center;
            padding: 40px;
        }
        
        .spinner-border {
            width: 3rem;
            height: 3rem;
            color: var(--primary);
        }
        
        .badge {
            border-radius: 8px;
            padding: 8px 12px;
            font-weight: 500;
        }
        
        .alert {
            border-radius: 10px;
            border: none;
        }
        
        .table-responsive {
            border-radius: 10px;
        }
        
        @media (max-width: 768px) {
            .action-buttons {
                flex-direction: column;
            }
            
            .app-header {
                padding: 20px 15px;
            }
            
            .stats-card {
                margin-bottom: 15px;
            }
        }
        
        .floating-btn {
            position: fixed;
            bottom: 30px;
            left: 30px;
            z-index: 100;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .toast-container {
            z-index: 1055;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <div class="app-container">
            <!-- رأس التطبيق -->
            <div class="app-header">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <div class="app-logo">
                            <i class="fas fa-oil-can"></i>
                            <div>
                                <h1 class="h3 mb-1">نظام إدارة المخزون</h1>
                                <p class="mb-0 opacity-75">شركة بتروبارت لمعدات البترول المحدودة</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 text-md-end mt-3 mt-md-0">
                        <div class="exchange-rate-card d-inline-block">
                            <div class="d-flex align-items-center justify-content-end">
                                <span class="me-2">سعر الدولار:</span>
                                <input type="number" id="exchangeRate" class="form-control form-control-sm d-inline-block text-center" style="width: 120px;" value="3400">
                                <span class="ms-2">جنيه سوداني</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- المحتوى الرئيسي -->
            <div class="container-fluid p-4">
                <!-- إحصائيات سريعة -->
                <div class="row mb-4">
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="stats-card">
                            <i class="fas fa-boxes"></i>
                            <div class="number text-primary" id="totalItems">0</div>
                            <div class="label">إجمالي قطع الغيار</div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="stats-card">
                            <i class="fas fa-shopping-cart"></i>
                            <div class="number text-success" id="totalSales">0</div>
                            <div class="label">إجمالي المبيعات</div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="stats-card">
                            <i class="fas fa-dollar-sign"></i>
                            <div class="number text-warning" id="totalValue">0</div>
                            <div class="label">القيمة الإجمالية (دولار)</div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="stats-card">
                            <i class="fas fa-exchange-alt"></i>
                            <div class="number text-info" id="totalTransactions">0</div>
                            <div class="label">إجمالي العمليات</div>
                        </div>
                    </div>
                </div>

                <!-- البحث والإجراءات -->
                <div class="row mb-4">
                    <div class="col-md-8">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="searchInput" class="form-control" placeholder="ابحث عن قطع الغيار...">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#addItemModal">
                            <i class="fas fa-plus me-2"></i>إضافة قطعة غيار
                        </button>
                    </div>
                </div>

                <!-- جدول المخزون -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-table me-2"></i>سجل المخزون</span>
                        <button class="btn btn-sm btn-outline-primary" id="refreshBtn">
                            <i class="fas fa-sync-alt me-1"></i>تحديث البيانات
                        </button>
                    </div>
                    <div class="card-body p-0">
                        <div id="inventoryLoading" class="loading">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">جاري التحميل...</span>
                            </div>
                            <p class="mt-3">جاري تحميل بيانات المخزون...</p>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th width="50">#</th>
                                        <th>اسم قطعة الغيار</th>
                                        <th width="120">الكمية</th>
                                        <th width="150">السعر (دولار)</th>
                                        <th width="150">السعر (جنيه)</th>
                                        <th width="140">تاريخ العملية</th>
                                        <th width="220">الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="inventoryTable">
                                    <!-- سيتم ملء الجدول ديناميكياً -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- تقرير المبيعات -->
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-chart-bar me-2"></i>تقرير المبيعات
                    </div>
                    <div class="card-body p-0">
                        <div id="salesLoading" class="loading">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">جاري التحميل...</span>
                            </div>
                            <p class="mt-3">جاري تحميل تقرير المبيعات...</p>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th width="50">#</th>
                                        <th>اسم قطعة الغيار</th>
                                        <th width="120">الكمية المباعة</th>
                                        <th width="150">السعر (دولار)</th>
                                        <th width="150">القيمة الإجمالية (دولار)</th>
                                        <th width="150">القيمة الإجمالية (جنيه)</th>
                                        <th width="140">تاريخ البيع</th>
                                    </tr>
                                </thead>
                                <tbody id="salesReportTable">
                                    <!-- سيتم ملء الجدول ديناميكياً -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- زر الإضافة العائم -->
    <button class="floating-btn btn btn-primary" data-bs-toggle="modal" data-bs-target="#addItemModal">
        <i class="fas fa-plus"></i>
    </button>

    <!-- نموذج إضافة قطعة غيار -->
    <div class="modal fade" id="addItemModal" tabindex="-1" aria-labelledby="addItemModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addItemModalLabel"><i class="fas fa-plus me-2"></i>إضافة قطعة غيار جديدة</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addItemForm">
                        <div class="mb-3">
                            <label for="itemName" class="form-label">اسم قطعة الغيار</label>
                            <input type="text" class="form-control" id="itemName" required>
                        </div>
                        <div class="mb-3">
                            <label for="itemQuantity" class="form-label">الكمية</label>
                            <input type="number" class="form-control" id="itemQuantity" min="1" required>
                        </div>
                        <div class="mb-3">
                            <label for="itemPrice" class="form-label">السعر (دولار)</label>
                            <input type="number" step="0.01" class="form-control" id="itemPrice" min="0" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" id="saveItemBtn">حفظ القطعة</button>
                </div>
            </div>
        </div>
    </div>

    <!-- نموذج السحب (المبيعات) -->
    <div class="modal fade" id="withdrawModal" tabindex="-1" aria-labelledby="withdrawModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="withdrawModalLabel"><i class="fas fa-minus me-2"></i>سحب من المخزون (بيع)</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="withdrawForm">
                        <div class="mb-3">
                            <label for="withdrawItemName" class="form-label">اسم قطعة الغيار</label>
                            <input type="text" class="form-control" id="withdrawItemName" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="availableQuantity" class="form-label">الكمية المتاحة</label>
                            <input type="number" class="form-control" id="availableQuantity" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="withdrawQuantity" class="form-label">الكمية المسحوبة</label>
                            <input type="number" class="form-control" id="withdrawQuantity" min="1" required>
                        </div>
                        <div class="mb-3">
                            <label for="withdrawPrice" class="form-label">السعر (دولار)</label>
                            <input type="number" step="0.01" class="form-control" id="withdrawPrice" readonly>
                        </div>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            سيتم خصم الكمية المسحوبة من المخزون وتسجيلها كعملية بيع.
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-success" id="confirmWithdrawBtn">تأكيد السحب</button>
                </div>
            </div>
        </div>
    </div>

    <!-- نموذج التعديل -->
    <div class="modal fade" id="editItemModal" tabindex="-1" aria-labelledby="editItemModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editItemModalLabel"><i class="fas fa-edit me-2"></i>تعديل بيانات قطعة الغيار</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editItemForm">
                        <input type="hidden" id="editItemId">
                        <div class="mb-3">
                            <label for="editItemName" class="form-label">اسم قطعة الغيار</label>
                            <input type="text" class="form-control" id="editItemName" required>
                        </div>
                        <div class="mb-3">
                            <label for="editItemQuantity" class="form-label">الكمية</label>
                            <input type="number" class="form-control" id="editItemQuantity" min="0" required>
                        </div>
                        <div class="mb-3">
                            <label for="editItemPrice" class="form-label">السعر (دولار)</label>
                            <input type="number" step="0.01" class="form-control" id="editItemPrice" min="0" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" id="updateItemBtn">تحديث البيانات</button>
                </div>
            </div>
        </div>
    </div>

    <!-- منطقة الإشعارات -->
    <div class="toast-container position-fixed top-0 end-0 p-3">
        <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <i class="fas fa-info-circle me-2 text-primary"></i>
                <strong class="me-auto">إشعار النظام</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="toastMessage">
                <!-- سيتم ملء الرسالة هنا -->
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // إعدادات API
        const SHEETDB_API_BASE = 'https://sheetdb.io/api/v1/0guo3ig4l25ow';
        const SHEETDB_INVENTORY_URL = `${SHEETDB_API_BASE}/inventory`;
        const SHEETDB_SALES_URL = `${SHEETDB_API_BASE}/sales`;
        
        // بيانات التطبيق
        let inventoryData = [];
        let salesData = [];
        let currentExchangeRate = 3400;
        
        // عناصر DOM
        const exchangeRateInput = document.getElementById('exchangeRate');
        const searchInput = document.getElementById('searchInput');
        const inventoryTable = document.getElementById('inventoryTable');
        const salesReportTable = document.getElementById('salesReportTable');
        const refreshBtn = document.getElementById('refreshBtn');
        const saveItemBtn = document.getElementById('saveItemBtn');
        const confirmWithdrawBtn = document.getElementById('confirmWithdrawBtn');
        const updateItemBtn = document.getElementById('updateItemBtn');
        const inventoryLoading = document.getElementById('inventoryLoading');
        const salesLoading = document.getElementById('salesLoading');
        
        // إحصائيات
        const totalItemsElement = document.getElementById('totalItems');
        const totalSalesElement = document.getElementById('totalSales');
        const totalValueElement = document.getElementById('totalValue');
        const totalTransactionsElement = document.getElementById('totalTransactions');
        
        // تهيئة التطبيق
        document.addEventListener('DOMContentLoaded', function() {
            loadInventoryData();
            loadSalesData();
            updateExchangeRate();
            
            // إضافة مستمعي الأحداث
            exchangeRateInput.addEventListener('change', updateExchangeRate);
            searchInput.addEventListener('input', filterInventory);
            refreshBtn.addEventListener('click', loadAllData);
            saveItemBtn.addEventListener('click', addNewItem);
            confirmWithdrawBtn.addEventListener('click', withdrawItem);
            updateItemBtn.addEventListener('click', updateItem);
            
            // إخفاء مؤشرات التحميل في البداية
            inventoryLoading.style.display = 'none';
            salesLoading.style.display = 'none';
        });
        
        // تحديث سعر الصرف
        function updateExchangeRate() {
            currentExchangeRate = parseFloat(exchangeRateInput.value) || 3400;
            renderInventoryTable();
            renderSalesReport();
            updateStats();
        }
        
        // تحميل جميع البيانات
        function loadAllData() {
            loadInventoryData();
            loadSalesData();
        }
        
        // تحميل بيانات المخزون من sheetdb.io
        async function loadInventoryData() {
            try {
                inventoryLoading.style.display = 'block';
                const response = await fetch(SHEETDB_INVENTORY_URL);
                
                if (!response.ok) {
                    throw new Error('فشل في جلب بيانات المخزون');
                }
                
                const data = await response.json();
                inventoryData = data;
                renderInventoryTable();
                updateStats();
            } catch (error) {
                console.error('Error loading inventory:', error);
                showToast('حدث خطأ في تحميل بيانات المخزون: ' + error.message, 'danger');
            } finally {
                inventoryLoading.style.display = 'none';
            }
        }
        
        // تحميل بيانات المبيعات من sheetdb.io
        async function loadSalesData() {
            try {
                salesLoading.style.display = 'block';
                const response = await fetch(SHEETDB_SALES_URL);
                
                if (!response.ok) {
                    throw new Error('فشل في جلب بيانات المبيعات');
                }
                
                const data = await response.json();
                salesData = data;
                renderSalesReport();
                updateStats();
            } catch (error) {
                console.error('Error loading sales:', error);
                showToast('حدث خطأ في تحميل بيانات المبيعات: ' + error.message, 'danger');
            } finally {
                salesLoading.style.display = 'none';
            }
        }
        
        // إضافة عنصر جديد إلى المخزون
        async function addNewItem() {
            const name = document.getElementById('itemName').value.trim();
            const quantity = parseInt(document.getElementById('itemQuantity').value);
            const price = parseFloat(document.getElementById('itemPrice').value);
            
            if (!name || isNaN(quantity) || isNaN(price)) {
                showToast('يرجى ملء جميع الحقول بشكل صحيح!', 'warning');
                return;
            }
            
            if (quantity <= 0 || price < 0) {
                showToast('يرجى إدخال قيم صحيحة للكمية والسعر!', 'warning');
                return;
            }
            
            try {
                const newItem = {
                    id: Date.now().toString(),
                    name: name,
                    quantity: quantity,
                    price: price,
                    date: new Date().toISOString().split('T')[0]
                };
                
                const response = await fetch(SHEETDB_INVENTORY_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ data: newItem })
                });
                
                if (!response.ok) {
                    throw new Error('فشل في إضافة العنصر');
                }
                
                // إغلاق النموذج
                const addModal = bootstrap.Modal.getInstance(document.getElementById('addItemModal'));
                addModal.hide();
                
                // إعادة تعيين النموذج
                document.getElementById('addItemForm').reset();
                
                // تحديث البيانات
                await loadInventoryData();
                
                showToast('تمت إضافة قطعة الغيار بنجاح!', 'success');
            } catch (error) {
                console.error('Error adding item:', error);
                showToast('حدث خطأ في إضافة العنصر: ' + error.message, 'danger');
            }
        }
        
        // سحب عنصر (بيع)
        async function withdrawItem() {
            const itemId = confirmWithdrawBtn.getAttribute('data-item-id');
            const quantity = parseInt(document.getElementById('withdrawQuantity').value);
            
            if (isNaN(quantity) || quantity <= 0) {
                showToast('يرجى إدخال كمية صحيحة!', 'warning');
                return;
            }
            
            try {
                const item = inventoryData.find(i => i.id === itemId);
                
                if (!item) {
                    showToast('لم يتم العثور على العنصر!', 'danger');
                    return;
                }
                
                if (parseInt(item.quantity) < quantity) {
                    showToast('الكمية المطلوبة غير متاحة في المخزون!', 'warning');
                    return;
                }
                
                // تحديث الكمية في المخزون
                const updatedQuantity = parseInt(item.quantity) - quantity;
                const updateResponse = await fetch(`${SHEETDB_INVENTORY_URL}/id/${itemId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        data: { quantity: updatedQuantity } 
                    })
                });
                
                if (!updateResponse.ok) {
                    throw new Error('فشل في تحديث المخزون');
                }
                
                // إضافة إلى سجل المبيعات
                const sale = {
                    id: Date.now().toString(),
                    item_id: itemId,
                    name: item.name,
                    quantity: quantity,
                    price: item.price,
                    date: new Date().toISOString().split('T')[0]
                };
                
                const saleResponse = await fetch(SHEETDB_SALES_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ data: sale })
                });
                
                if (!saleResponse.ok) {
                    throw new Error('فشل في تسجيل عملية البيع');
                }
                
                // إغلاق النموذج
                const withdrawModal = bootstrap.Modal.getInstance(document.getElementById('withdrawModal'));
                withdrawModal.hide();
                
                // تحديث البيانات
                await loadInventoryData();
                await loadSalesData();
                
                showToast('تم سحب الكمية بنجاح!', 'success');
            } catch (error) {
                console.error('Error withdrawing item:', error);
                showToast('حدث خطأ في عملية السحب: ' + error.message, 'danger');
            }
        }
        
        // تحديث عنصر
        async function updateItem() {
            const itemId = document.getElementById('editItemId').value;
            const name = document.getElementById('editItemName').value.trim();
            const quantity = parseInt(document.getElementById('editItemQuantity').value);
            const price = parseFloat(document.getElementById('editItemPrice').value);
            
            if (!name || isNaN(quantity) || isNaN(price)) {
                showToast('يرجى ملء جميع الحقول بشكل صحيح!', 'warning');
                return;
            }
            
            if (quantity < 0 || price < 0) {
                showToast('يرجى إدخال قيم صحيحة للكمية والسعر!', 'warning');
                return;
            }
            
            try {
                const updatedData = {
                    name: name,
                    quantity: quantity,
                    price: price
                };
                
                const response = await fetch(`${SHEETDB_INVENTORY_URL}/id/${itemId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ data: updatedData })
                });
                
                if (!response.ok) {
                    throw new Error('فشل في تحديث العنصر');
                }
                
                // إغلاق النموذج
                const editModal = bootstrap.Modal.getInstance(document.getElementById('editItemModal'));
                editModal.hide();
                
                // تحديث البيانات
                await loadInventoryData();
                
                showToast('تم تحديث البيانات بنجاح!', 'success');
            } catch (error) {
                console.error('Error updating item:', error);
                showToast('حدث خطأ في تحديث العنصر: ' + error.message, 'danger');
            }
        }
        
        // حذف عنصر
        async function deleteItem(itemId) {
            if (!confirm('هل أنت متأكد من حذف هذه القطعة؟')) {
                return;
            }
            
            try {
                const response = await fetch(`${SHEETDB_INVENTORY_URL}/id/${itemId}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    throw new Error('فشل في حذف العنصر');
                }
                
                // تحديث البيانات
                await loadInventoryData();
                
                showToast('تم حذف القطعة بنجاح!', 'success');
            } catch (error) {
                console.error('Error deleting item:', error);
                showToast('حدث خطأ في حذف العنصر: ' + error.message, 'danger');
            }
        }
        
        // عرض جدول المخزون
        function renderInventoryTable() {
            let tableHTML = '';
            
            if (inventoryData.length === 0) {
                tableHTML = `<tr><td colspan="7" class="text-center py-4">لا توجد بيانات في المخزون</td></tr>`;
            } else {
                inventoryData.forEach((item, index) => {
                    const priceInSDG = (parseFloat(item.price) * currentExchangeRate).toFixed(2);
                    const quantity = parseInt(item.quantity);
                    const quantityBadge = quantity < 10 ? 
                        `<span class="badge bg-danger">${quantity}</span>` : 
                        `<span class="badge bg-success">${quantity}</span>`;
                    
                    tableHTML += `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${item.name}</td>
                            <td>${quantityBadge}</td>
                            <td>$${parseFloat(item.price).toFixed(2)}</td>
                            <td>${priceInSDG} ج.س</td>
                            <td>${item.date}</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-sm btn-success" onclick="openWithdrawModal('${item.id}')">
                                        <i class="fas fa-minus me-1"></i>سحب
                                    </button>
                                    <button class="btn btn-sm btn-warning" onclick="openEditModal('${item.id}')">
                                        <i class="fas fa-edit me-1"></i>تعديل
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteItem('${item.id}')">
                                        <i class="fas fa-trash me-1"></i>حذف
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
            }
            
            inventoryTable.innerHTML = tableHTML;
        }
        
        // عرض تقرير المبيعات
        function renderSalesReport() {
            let tableHTML = '';
            
            if (salesData.length === 0) {
                tableHTML = `<tr><td colspan="7" class="text-center py-4">لا توجد بيانات مبيعات</td></tr>`;
            } else {
                salesData.forEach((sale, index) => {
                    const totalPriceUSD = (parseInt(sale.quantity) * parseFloat(sale.price)).toFixed(2);
                    const totalPriceSDG = (parseInt(sale.quantity) * parseFloat(sale.price) * currentExchangeRate).toFixed(2);
                    
                    tableHTML += `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${sale.name}</td>
                            <td>${sale.quantity}</td>
                            <td>$${parseFloat(sale.price).toFixed(2)}</td>
                            <td>$${totalPriceUSD}</td>
                            <td>${totalPriceSDG} ج.س</td>
                            <td>${sale.date}</td>
                        </tr>
                    `;
               
