<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إدارة مخزون قطع الغيار</title>
    <!-- تحميل Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- تحميل مكتبة الأيقونات Heroicons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/heroicons/2.0.16/24/outline/heroicons.min.css" rel="stylesheet">
    <!-- تحميل Chart.js للرسوم البيانية -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* خط مخصص لتحسين الواجهة باللغة العربية */
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap');
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #f3f4f6;
        }
        /* إخفاء أزرار زيادة ونقصان الرقم في حقول الإدخال */
        input[type='number']::-webkit-inner-spin-button,
        input[type='number']::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type='number'] {
            -moz-appearance: textfield;
        }
        .modal {
            transition: opacity 0.3s ease;
        }
        /* For report tabs */
        .tab-btn.active {
            border-color: #3b82f6;
            color: #3b82f6;
            background-color: #eff6ff;
        }
        /* تحسين مظهر الرسوم البيانية */
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="app" class="container mx-auto p-4 sm:p-6 lg:p-8">
        
        <!-- اسم الشركة -->
        <div class="text-center mb-6">
            <img src="data:image/png;base64,ضع_كود_الصورة_المحول_هنا" alt="شعار شركة بتروبارت" class="mx-auto h-24 w-auto mb-4">
            <h1 class="text-3xl font-bold text-gray-800">بتروبارت لمعدات البترول المحدودة</h1>
            <p class="text-lg text-gray-600">Petro-Part Petroleum Equipment Ltd</p>
        </div>

        <!-- رأس الصفحة ومنطقة التحكم -->
        <header class="bg-white p-4 rounded-lg shadow-md mb-6">
            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-4 items-center">
                <!-- مربع البحث -->
                <div class="lg:col-span-2">
                    <div class="relative">
                        <input type="text" id="searchInput" placeholder="ابحث عن قطعة غيار..." class="w-full p-2 pr-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <svg class="w-5 h-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                        </svg>
                    </div>
                </div>

                <!-- سعر الدولار -->
                <div class="lg:col-span-1 flex items-center gap-2">
                    <label for="dollarRate" class="font-semibold text-gray-700 whitespace-nowrap">سعر الدولار:</label>
                    <input type="number" id="dollarRate" value="3400" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <!-- أزرار الإجراءات -->
                <div class="lg:col-span-3 flex flex-col sm:flex-row gap-3">
                    <button id="addPartBtn" class="w-full flex items-center justify-center gap-2 bg-green-500 text-white p-2 rounded-lg hover:bg-green-600 transition duration-300 shadow">
                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
                        إضافة قطعة
                    </button>
                    <button id="withdrawBtn" class="w-full flex items-center justify-center gap-2 bg-red-500 text-white p-2 rounded-lg hover:bg-red-600 transition duration-300 shadow">
                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 12h-15" /></svg>
                        سحب كمية
                    </button>
                    <button id="salesReportBtn" class="w-full flex items-center justify-center gap-2 bg-blue-500 text-white p-2 rounded-lg hover:bg-blue-600 transition duration-300 shadow">
                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h15.75c.621 0 1.125.504 1.125 1.125v6.75c0 .621-.504 1.125-1.125 1.125H4.125c-.621 0-1.125-.504-1.125-1.125v-6.75z" /><path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125V9.75a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 9.75v3.375" /><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 7.5h.008v.008h-.008V7.5z" /></svg>
                        تقرير المبيعات
                    </button>
                </div>
            </div>
        </header>

        <!-- جدول المخزون -->
        <main class="bg-white p-4 rounded-lg shadow-md">
            <h2 class="text-xl font-bold mb-4 text-gray-800">قائمة قطع الغيار</h2>
            <div id="loader" class="text-center py-10">
                <p>جاري تحميل البيانات...</p>
            </div>
            <div class="overflow-x-auto">
                <table id="inventoryTable" class="w-full text-center hidden">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="p-3">#</th>
                            <th class="p-3">اسم الاسبير</th>
                            <th class="p-3">العدد</th>
                            <th class="p-3">السعر ($)</th>
                            <th class="p-3">السعر بالجنيه السوداني</th>
                            <th class="p-3">تاريخ آخر سحب</th>
                            <th class="p-3">تعديل</th>
                        </tr>
                    </thead>
                    <tbody id="inventoryTableBody" class="divide-y divide-gray-200">
                        <!-- سيتم تعبئة الصفوف هنا عبر JavaScript -->
                    </tbody>
                </table>
                 <p id="noDataMessage" class="text-center py-10 text-gray-500 hidden">لا توجد بيانات لعرضها. حاول إضافة قطعة جديدة.</p>
            </div>
        </main>
    </div>

    <!-- Modals (Pop-ups) -->

    <!-- Modal: إضافة قطعة جديدة -->
    <div id="addPartModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0">
        <div class="bg-white rounded-lg p-6 w-full max-w-md transform scale-95 transition-transform duration-300">
            <h3 class="text-lg font-bold mb-4">إضافة قطعة غيار جديدة</h3>
            <form id="addPartForm">
                <div class="mb-4">
                    <label for="partName" class="block mb-2">اسم القطعة</label>
                    <input type="text" id="partName" class="w-full p-2 border rounded" required>
                </div>
                <div class="mb-4">
                    <label for="partQuantity" class="block mb-2">الكمية</label>
                    <input type="number" id="partQuantity" class="w-full p-2 border rounded" required min="0">
                </div>
                <div class="mb-4">
                    <label for="partPrice" class="block mb-2">السعر ($)</label>
                    <input type="number" id="partPrice" class="w-full p-2 border rounded" required min="0" step="0.01">
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" class="close-modal bg-gray-300 text-black px-4 py-2 rounded">إلغاء</button>
                    <button type="submit" class="bg-green-500 text-white px-4 py-2 rounded">إضافة</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: تعديل قطعة -->
    <div id="editPartModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0">
        <div class="bg-white rounded-lg p-6 w-full max-w-md transform scale-95 transition-transform duration-300">
            <h3 class="text-lg font-bold mb-4">تعديل بيانات القطعة</h3>
            <form id="editPartForm">
                <input type="hidden" id="editPartId">
                <div class="mb-4">
                    <label for="editPartName" class="block mb-2">اسم القطعة</label>
                    <input type="text" id="editPartName" class="w-full p-2 border rounded" required>
                </div>
                <div class="mb-4">
                    <label for="editPartQuantity" class="block mb-2">الكمية</label>
                    <input type="number" id="editPartQuantity" class="w-full p-2 border rounded" required min="0">
                </div>
                <div class="mb-4">
                    <label for="editPartPrice" class="block mb-2">السعر ($)</label>
                    <input type="number" id="editPartPrice" class="w-full p-2 border rounded" required min="0" step="0.01">
                </div>
                <div class="flex justify-between items-center mt-6">
                     <button type="button" id="triggerDeleteBtn" class="bg-red-600 text-white px-4 py-2 rounded flex items-center gap-2 hover:bg-red-700">
                        <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.134-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.067-2.09 1.02-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" /></svg>
                        حذف
                    </button>
                    <div class="flex gap-3">
                        <button type="button" class="close-modal bg-gray-300 text-black px-4 py-2 rounded">إلغاء</button>
                        <button type="submit" class="bg-yellow-500 text-white px-4 py-2 rounded">حفظ التعديلات</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal: تأكيد الحذف -->
    <div id="deleteConfirmModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0">
        <div class="bg-white rounded-lg p-6 w-full max-w-sm transform scale-95 transition-transform duration-300 text-center">
            <h3 class="text-lg font-bold mb-4">تأكيد الحذف</h3>
            <p class="mb-6">هل أنت متأكد أنك تريد حذف هذه القطعة؟ لا يمكن التراجع عن هذا الإجراء.</p>
            <input type="hidden" id="deletePartId">
            <div class="flex justify-center gap-3">
                <button type="button" class="close-modal bg-gray-300 text-black px-4 py-2 rounded">إلغاء</button>
                <button type="button" id="confirmDeleteBtn" class="bg-red-600 text-white px-4 py-2 rounded">تأكيد الحذف</button>
            </div>
        </div>
    </div>

    <!-- Modal: سحب كمية (بيع) -->
    <div id="withdrawModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0">
        <div class="bg-white rounded-lg p-6 w-full max-w-md transform scale-95 transition-transform duration-300">
            <h3 class="text-lg font-bold mb-4">سحب كمية / بيع</h3>
            <form id="withdrawForm" class="space-y-4">
                <div>
                    <label for="partSelector" class="block mb-2">اختر القطعة</label>
                    <select id="partSelector" class="w-full p-2 border rounded" required></select>
                </div>
                <div>
                    <p><strong>الكمية المتاحة:</strong> <span id="withdrawAvailableQuantity">N/A</span></p>
                </div>
                <div>
                    <label for="withdrawQuantity" class="block mb-2">الكمية المراد سحبها</label>
                    <input type="number" id="withdrawQuantity" class="w-full p-2 border rounded" required min="1">
                </div>
                <div>
                    <label for="buyerName" class="block mb-2">اسم المشتري</label>
                    <input type="text" id="buyerName" class="w-full p-2 border rounded" required>
                </div>
                <div>
                    <label for="saleNotes" class="block mb-2">ملاحظات</label>
                    <textarea id="saleNotes" class="w-full p-2 border rounded" rows="2"></textarea>
                </div>
                <div class="flex justify-end gap-3 pt-2">
                    <button type="button" class="close-modal bg-gray-300 text-black px-4 py-2 rounded">إلغاء</button>
                    <button type="submit" class="bg-red-500 text-white px-4 py-2 rounded">تأكيد السحب</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: تقرير المبيعات -->
    <div id="salesReportModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0">
        <div class="bg-white rounded-lg p-6 w-full max-w-5xl transform scale-95 transition-transform duration-300 h-full max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h3 class="text-xl font-bold">تقرير وتحليل العمليات</h3>
                <button class="close-modal text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <div id="reportLoader" class="text-center py-10">
                <p>جاري تحميل التقرير...</p>
            </div>
            <div id="reportContainer" class="flex-grow overflow-y-auto hidden">
                <!-- Tabs -->
                <div class="mb-4 border-b border-gray-200">
                    <nav class="-mb-px flex gap-4" id="reportTabs">
                         <button data-tab="analysis" class="tab-btn active whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">تحليل المبيعات</button>
                         <button data-tab="sales" class="tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">سجل المبيعات</button>
                         <button data-tab="additions" class="tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">سجل الإضافات</button>
                         <button data-tab="charts" class="tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">الرسوم البيانية</button>
                    </nav>
                </div>
                <!-- Tab Content -->
                <div id="reportContent"></div>
            </div>
        </div>
    </div>
    
    <!-- رسالة تأكيد أو خطأ -->
    <div id="toast" class="fixed bottom-5 right-5 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg hidden opacity-0 transition-opacity duration-300">
        تمت العملية بنجاح!
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // =================================================================
            // الإعدادات الرئيسية - **مهم جداً: قم بإعداد هذه الروابط**
            // =================================================================
            // 1. رابط API لورقة Google Sheet التي تحتوي على **بيانات المخزون**
            // الأعمدة المطلوبة: 'رقم القطعة', 'اسم الاسبير', 'العدد', 'السعر بالدولار', 'السعر بالجنيه السوداني', 'تاريخ آخر سحب'
            const INVENTORY_API_URL = 'https://sheetdb.io/api/v1/0guo3ig4l25ow';

            // 2. رابط API لورقة Google Sheet جديدة باسم `sales` لتسجيل **المبيعات**
            // الأعمدة المطلوبة: 'اسم الاسبير', 'الكمية المباعة', 'سعر الوحدة', 'إجمالي البيع', 'المشتري', 'الملاحظات', 'تاريخ البيع'
            const SALES_API_URL = 'https://sheetdb.io/api/v1/YOUR_SALES_SHEET_API';

            // 3. رابط API لورقة Google Sheet جديدة باسم `additions` لتسجيل **الإضافات للمخزون**
            // الأعمدة المطلوبة: 'timestamp', 'part_name', 'quantity', 'cost_usd', 'total_cost_local'
            const ADDITIONS_LOG_API_URL = 'https://sheetdb.io/api/v1/YOUR_ADDITIONS_SHEET_API';

            // =================================================================
            // تعريف العناصر
            // =================================================================
            const inventoryTableBody = document.getElementById('inventoryTableBody');
            const loader = document.getElementById('loader');
            const noDataMessage = document.getElementById('noDataMessage');
            const searchInput = document.getElementById('searchInput');
            const dollarRateInput = document.getElementById('dollarRate');
            const toast = document.getElementById('toast');

            let inventoryData = []; // لتخزين بيانات المخزون محلياً
            let charts = {}; // لتخزين الرسوم البيانية

            // =================================================================
            // دوال المساعدة (فتح وإغلاق النوافذ، إظهار الرسائل)
            // =================================================================
            function showToast(message, isError = false) { 
                toast.textContent = message; 
                toast.className = `fixed bottom-5 right-5 text-white px-6 py-3 rounded-lg shadow-lg transition-opacity duration-300 ${isError ? 'bg-red-500' : 'bg-green-500'}`; 
                toast.classList.remove('hidden', 'opacity-0');
                setTimeout(() => {
                    toast.classList.add('opacity-0');
                    setTimeout(() => toast.classList.add('hidden'), 300);
                }, 3000); 
            }
            
            function openModal(modal) { 
                modal.classList.remove('hidden'); 
                setTimeout(() => { 
                    modal.classList.remove('opacity-0'); 
                    modal.querySelector('div').classList.remove('scale-95'); 
                }, 10); 
            }
            
            function closeModal(modal) { 
                modal.querySelector('div').classList.add('scale-95'); 
                modal.classList.add('opacity-0'); 
                setTimeout(() => modal.classList.add('hidden'), 300); 
            }
            
            document.querySelectorAll('.close-modal').forEach(btn => btn.addEventListener('click', () => closeModal(btn.closest('.modal'))));
            
            // =================================================================
            // دوال التعامل مع بيانات المخزون (عرض، بحث، تحديث)
            // =================================================================
            async function fetchInventory() {
                if(INVENTORY_API_URL.includes('YOUR_INVENTORY_SHEET_API')) { 
                    alert('يرجى تعديل رابط API الخاص بالمخزون في ملف inventory_manager.html'); 
                    loader.textContent = 'خطأ في الإعدادات.'; 
                    return; 
                }
                loader.style.display = 'block';
                document.getElementById('inventoryTable').classList.add('hidden');
                noDataMessage.classList.add('hidden');
                try {
                    const response = await fetch(INVENTORY_API_URL);
                    if (!response.ok) throw new Error('فشل في جلب البيانات');
                    const data = await response.json();
                    inventoryData = data.filter(item => item['اسم الاسبير']);
                    renderTable(inventoryData);
                } catch (error) { 
                    console.error('Error fetching inventory:', error); 
                    loader.textContent = 'حدث خطأ أثناء تحميل البيانات.';
                } finally {
                    loader.style.display = 'none';
                    if (inventoryData.length > 0) document.getElementById('inventoryTable').classList.remove('hidden');
                    else noDataMessage.classList.remove('hidden');
                }
            }
            
            function renderTable(data) {
                inventoryTableBody.innerHTML = '';
                if(data.length === 0) { 
                    noDataMessage.classList.remove('hidden'); 
                    document.getElementById('inventoryTable').classList.add('hidden'); 
                    return; 
                }
                noDataMessage.classList.add('hidden');
                document.getElementById('inventoryTable').classList.remove('hidden');
                const dollarRate = parseFloat(dollarRateInput.value) || 0;
                data.forEach((item, index) => {
                    const localPrice = (parseFloat(item['السعر بالدولار']) * dollarRate).toLocaleString('ar-SD', { style: 'currency', currency: 'SDG' });
                    const row = `
                        <tr class="hover:bg-gray-50">
                            <td class="p-3">${index + 1}</td>
                            <td class="p-3">${item['اسم الاسبير']}</td>
                            <td class="p-3">${item['العدد']}</td>
                            <td class="p-3">$${parseFloat(item['السعر بالدولار']).toFixed(2)}</td>
                            <td class="p-3">${localPrice}</td>
                            <td class="p-3">${item['تاريخ آخر سحب'] || '—'}</td>
                            <td class="p-3">
                                <button class="edit-btn bg-yellow-500 text-white p-2 rounded-full hover:bg-yellow-600" data-id="${item['رقم القطعة']}" data-name="${item['اسم الاسبير']}" data-quantity="${item['العدد']}" data-price="${item['السعر بالدولار']}">
                                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L6.832 19.82a4.5 4.5 0 01-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 011.13-1.897L16.863 4.487zm0 0L19.5 7.125" /></svg>
                                </button>
                            </td>
                        </tr>`;
                    inventoryTableBody.innerHTML += row;
                });
            }
            
            dollarRateInput.addEventListener('input', () => renderTable(inventoryData));
            searchInput.addEventListener('input', () => renderTable(inventoryData.filter(item => item['اسم الاسبير'].toLowerCase().includes(searchInput.value.toLowerCase()))));

            // =================================================================
            // CRUD (إضافة، تعديل، حذف)
            // =================================================================
            document.getElementById('addPartBtn').addEventListener('click', () => openModal(document.getElementById('addPartModal')));
            document.getElementById('addPartForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const priceInUSD = parseFloat(document.getElementById('partPrice').value);
                const newPart = {
                    'رقم القطعة': `part_${Date.now()}`,
                    'اسم الاسبير': document.getElementById('partName').value,
                    'العدد': document.getElementById('partQuantity').value,
                    'السعر بالدولار': priceInUSD,
                    'السعر بالجنيه السوداني': (priceInUSD * (parseFloat(dollarRateInput.value) || 0)).toFixed(2)
                };
                try {
                    const response = await fetch(INVENTORY_API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ data: [newPart] }) });
                    if (!response.ok) throw new Error('فشل في إضافة القطعة');
                    await logAddition(newPart);
                    showToast('تمت إضافة القطعة بنجاح');
                    e.target.reset();
                    closeModal(document.getElementById('addPartModal'));
                    fetchInventory();
                } catch (error) { 
                    console.error('Error adding part:', error); 
                    showToast('حدث خطأ أثناء الإضافة', true); 
                }
            });

            inventoryTableBody.addEventListener('click', (e) => {
                const editButton = e.target.closest('.edit-btn');
                if(editButton) {
                    const { id, name, quantity, price } = editButton.dataset;
                    document.getElementById('editPartId').value = id;
                    document.getElementById('editPartName').value = name;
                    document.getElementById('editPartQuantity').value = quantity;
                    document.getElementById('editPartPrice').value = price;
                    openModal(document.getElementById('editPartModal'));
                }
            });

            document.getElementById('editPartForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const partId = document.getElementById('editPartId').value;
                const priceInUSD = parseFloat(document.getElementById('editPartPrice').value);
                const updatedData = {
                    'اسم الاسبير': document.getElementById('editPartName').value,
                    'العدد': document.getElementById('editPartQuantity').value,
                    'السعر بالدولار': priceInUSD,
                    'السعر بالجنيه السوداني': (priceInUSD * (parseFloat(dollarRateInput.value) || 0)).toFixed(2)
                };
                try {
                    const response = await fetch(`${INVENTORY_API_URL}/${encodeURIComponent('رقم القطعة')}/${partId}`, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ data: updatedData }) });
                    if (!response.ok) throw new Error('فشل تحديث البيانات');
                    showToast('تم تحديث البيانات بنجاح');
                    e.target.reset();
                    closeModal(document.getElementById('editPartModal'));
                    fetchInventory();
                } catch (error) { 
                    console.error('Error updating part:', error); 
                    showToast('حدث خطأ أثناء التحديث', true); 
                }
            });

            document.getElementById('triggerDeleteBtn').addEventListener('click', () => {
                document.getElementById('deletePartId').value = document.getElementById('editPartId').value;
                closeModal(document.getElementById('editPartModal'));
                openModal(document.getElementById('deleteConfirmModal'));
            });

            document.getElementById('confirmDeleteBtn').addEventListener('click', async () => {
                const partId = document.getElementById('deletePartId').value;
                try {
                    const response = await fetch(`${INVENTORY_API_URL}/${encodeURIComponent('رقم القطعة')}/${partId}`, { method: 'DELETE' });
                    if (!response.ok) throw new Error('فشل حذف القطعة');
                    showToast('تم حذف القطعة بنجاح');
                    closeModal(document.getElementById('deleteConfirmModal'));
                    fetchInventory();
                } catch (error) { 
                    console.error('Error deleting part:', error); 
                    showToast('حدث خطأ أثناء الحذف', true); 
                }
            });
            
            // =================================================================
            // منطق سحب الكميات (البيع)
            // =================================================================
            document.getElementById('withdrawBtn').addEventListener('click', () => {
                const selector = document.getElementById('partSelector');
                selector.innerHTML = '<option value="">-- اختر قطعة غيار --</option>';
                inventoryData.forEach(part => { 
                    if (parseInt(part['العدد'], 10) > 0) 
                        selector.innerHTML += `<option value="${part['رقم القطعة']}">${part['اسم الاسبير']}</option>`; 
                });
                document.getElementById('withdrawAvailableQuantity').textContent = 'N/A';
                document.getElementById('withdrawQuantity').value = '';
                openModal(document.getElementById('withdrawModal'));
            });

            document.getElementById('partSelector').addEventListener('change', (e) => {
                const part = inventoryData.find(p => p['رقم القطعة'] === e.target.value);
                const qtySpan = document.getElementById('withdrawAvailableQuantity');
                const qtyInput = document.getElementById('withdrawQuantity');
                if(part) { 
                    qtySpan.textContent = part['العدد']; 
                    qtyInput.max = part['العدد']; 
                } 
                else { 
                    qtySpan.textContent = 'N/A'; 
                    qtyInput.max = ''; 
                }
            });

            document.getElementById('withdrawForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const partId = document.getElementById('partSelector').value;
                const quantityToSell = parseInt(document.getElementById('withdrawQuantity').value);
                const part = inventoryData.find(p => p['رقم القطعة'] === partId);
                if (!part || quantityToSell > parseInt(part['العدد']) || quantityToSell <= 0) { 
                    showToast('البيانات غير صالحة!', true); 
                    return; 
                }
                
                try {
                    const newQuantity = parseInt(part['العدد']) - quantityToSell;
                    const newDate = new Date().toLocaleString('ar-EG');
                    const response = await fetch(`${INVENTORY_API_URL}/${encodeURIComponent('رقم القطعة')}/${partId}`, {
                        method: 'PATCH', 
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ data: { 'العدد': newQuantity, 'تاريخ آخر سحب': newDate } })
                    });
                    if (!response.ok) throw new Error('فشل تحديث المخزون');
                    await logSale(part, quantityToSell);
                    showToast('تمت عملية السحب بنجاح');
                    e.target.reset();
                    closeModal(document.getElementById('withdrawModal'));
                    fetchInventory();
                } catch(error) { 
                    console.error('Error selling part:', error); 
                    showToast('حدث خطأ أثناء عملية السحب', true); 
                }
            });

            // =================================================================
            // دوال تسجيل العمليات (البيع والإضافة)
            // =================================================================
            async function logSale(part, quantity) {
                if(SALES_API_URL.includes('YOUR_SALES_SHEET_API')) return;
                const saleRecord = {
                    'اسم الاسبير': part['اسم الاسبير'],
                    'الكمية المباعة': quantity,
                    'سعر الوحدة': part['السعر بالدولار'],
                    'إجمالي البيع': (parseFloat(part['السعر بالدولار']) * quantity * parseFloat(dollarRateInput.value)).toFixed(2),
                    'المشتري': document.getElementById('buyerName').value,
                    'الملاحظات': document.getElementById('saleNotes').value,
                    'تاريخ البيع': new Date().toISOString()
                };
                await fetch(SALES_API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ data: [saleRecord] }) });
            }

            async function logAddition(part) {
                if(ADDITIONS_LOG_API_URL.includes('YOUR_ADDITIONS_SHEET_API')) return;
                const additionRecord = {
                    timestamp: new Date().toISOString(),
                    part_name: part['اسم الاسبير'],
                    quantity: part['العدد'],
                    cost_usd: part['السعر بالدولار'],
                    total_cost_local: parseFloat(part['السعر بالجنيه السوداني']).toFixed(2)
                };
                await fetch(ADDITIONS_LOG_API_URL, { method: 'POST', headers: { 'Content-Type': 'application
