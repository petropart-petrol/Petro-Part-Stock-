<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إدارة مخزن قطع الغيار - PETRO-PART</title>
    <style>
        /* يمكنك إضافة تنسيقات CSS هنا */
        body { font-family: Tahoma, sans-serif; margin: 20px; background-color: #f4f4f9; color: #333; }
        header { text-align: center; margin-bottom: 30px; }
        .logo { max-width: 150px; height: auto; }
        .container { max-width: 1200px; margin: auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .section { margin-bottom: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 5px; }
        .input-group, .controls { display: flex; gap: 10px; margin-bottom: 15px; align-items: center; }
        input[type="text"], input[type="number"] { padding: 10px; border: 1px solid #ccc; border-radius: 4px; flex-grow: 1; }
        button { padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; color: white; transition: background-color 0.3s; }
        #addPartBtn { background-color: #4CAF50; }
        #sellPartBtn { background-color: #f44336; }
        #salesReportBtn { background-color: #2196F3; }
        #exchangeRateContainer { background-color: #ffeb3b; padding: 10px; border-radius: 4px; color: #333; font-weight: bold; }
        #inventoryTable, #salesTable { width: 100%; border-collapse: collapse; margin-top: 15px; }
        #inventoryTable th, #salesTable th, #inventoryTable td, #salesTable td { border: 1px solid #ddd; padding: 8px; text-align: right; }
        #inventoryTable th, #salesTable th { background-color: #5d8aa8; color: white; }
    </style>
</head>
<body>

    <header>
        <img src="1739538005937.png" alt="شعار بتروبارت" class="logo">
        <h1>نظام إدارة مخزون قطع الغيار</h1>
    </header>

    <div class="container">

        <div id="exchangeRateContainer" class="section">
            <label for="usdRateInput">سعر صرف الدولار (SDG):</label>
            <div class="input-group">
                <input type="number" id="usdRateInput" value="3400" min="1" step="0.01">
                <button onclick="updateRate()">تحديث السعر</button>
            </div>
            <p>السعر الحالي: <span id="currentRateDisplay">3400</span> SDG</p>
        </div>

        <div class="section">
            <h2>بحث وعرض المخزون</h2>
            <div class="input-group">
                <input type="text" id="searchPartInput" placeholder="أدخل اسم أو رقم القطعة للبحث">
                <button onclick="searchInventory()">بحث</button>
            </div>
            <table id="inventoryTable">
                <thead>
                    <tr>
                        <th>id</th>
                        <th>item_id</th>
                        <th>name</th>
                        <th>quantity</th>
                        <th>price usd</th>
                        <th>price sdg</th>
                        <th>lastupdatedate</th>
                        <th>عمليات</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>

        <div class="section">
            <h2>إضافة قطع غيار جديدة</h2>
            <div class="input-group">
                <input type="text" id="add_item_id" placeholder="رقم القطعة (item_id)" required>
                <input type="text" id="add_name" placeholder="اسم القطعة" required>
                <input type="number" id="add_quantity" placeholder="الكمية" min="1" required>
                <input type="number" id="add_price_usd" placeholder="السعر بالدولار" min="0" step="0.01" required>
            </div>
            <div class="controls">
                <button id="addPartBtn" onclick="addPart()">إضافة قطع الغيار (Inventory)</button>
            </div>
        </div>

        <div class="section">
            <h2>سحب من المخزون (مبيعات)</h2>
            <div class="input-group">
                <input type="text" id="sell_item_id" placeholder="رقم القطعة المراد سحبها (item_id)" required>
                <input type="number" id="sell_quantity" placeholder="كمية السحب" min="1" required>
            </div>
            <div class="controls">
                <button id="sellPartBtn" onclick="sellPart()">سحب الكمية (مبيعات)</button>
            </div>
        </div>

        <div class="section">
            <h2>تقرير المبيعات والعمليات</h2>
            <div class="controls">
                <button id="salesReportBtn" onclick="showSalesReport()">إظهار تقرير المبيعات</button>
            </div>
            <table id="salesTable" style="display: none;">
                <thead>
                    <tr>
                        <th>id</th>
                        <th>item_id</th>
                        <th>name</th>
                        <th>quantity</th>
                        <th>price usd</th>
                        <th>price sdg</th>
                        <th>lastupdatedate</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>

    </div>

    <script>
        // المتغيرات الرئيسية
        const API_BASE_URL = 'https://sheetdb.io/api/v1/0guo3ig4l25ow';
        let currentUSD_SDG_Rate = parseFloat(document.getElementById('usdRateInput').value);

        // **1. وظيفة تحديث سعر الصرف**
        function updateRate() {
            const newRate = parseFloat(document.getElementById('usdRateInput').value);
            if (newRate > 0) {
                currentUSD_SDG_Rate = newRate;
                document.getElementById('currentRateDisplay').textContent = newRate.toFixed(2);
                alert('تم تحديث سعر الصرف إلى ' + newRate.toFixed(2) + ' SDG');
                // ملاحظة: قد تحتاج إلى تحديث عرض الأسعار في جدول المخزون بعد تغيير السعر
                loadInventory();
            } else {
                alert('الرجاء إدخال سعر صرف صحيح.');
            }
        }

        // **2. وظيفة جلب وعرض المخزون**
        async function loadInventory(searchQuery = '') {
            try {
                const sheet = 'Inventory';
                let url = `${API_BASE_URL}?sheet=${sheet}`;
                
                if (searchQuery) {
                    // البحث عن طريق name أو item_id. يتم ترميز الاستعلام للبحث في SheetDB
                    url += `&search_id=${searchQuery}&search_name=${searchQuery}`; 
                }

                const response = await fetch(url);
                const data = await response.json();
                const tableBody = document.querySelector('#inventoryTable tbody');
                tableBody.innerHTML = ''; // تفريغ الجدول

                data.forEach(item => {
                    const price_sdg = (parseFloat(item.price_usd) * currentUSD_SDG_Rate).toFixed(2);
                    const row = tableBody.insertRow();
                    row.innerHTML = `
                        <td>${item.id}</td>
                        <td>${item.item_id}</td>
                        <td>${item.name}</td>
                        <td>${item.quantity}</td>
                        <td>${parseFloat(item.price_usd).toFixed(2)}</td>
                        <td>${price_sdg}</td>
                        <td>${item.lastupdatedate || new Date().toLocaleString()}</td>
                        <td>
                            <button onclick="prepareUpdate('${item.id}', '${item.item_id}', '${item.name}', ${item.quantity}, ${item.price_usd})">تعديل</button>
                        </td>
                    `;
                });
            } catch (error) {
                console.error('خطأ في جلب بيانات المخزون:', error);
                alert('حدث خطأ أثناء جلب بيانات المخزون.');
            }
        }

        // **1- مربع البحث**
        function searchInventory() {
            const query = document.getElementById('searchPartInput').value.trim();
            loadInventory(query);
        }

        // **2- وظيفة إضافة قطعة غيار جديدة (POST)**
        async function addPart() {
            const item_id = document.getElementById('add_item_id').value;
            const name = document.getElementById('add_name').value;
            const quantity = parseInt(document.getElementById('add_quantity').value);
            const price_usd = parseFloat(document.getElementById('add_price_usd').value);

            if (!item_id || !name || isNaN(quantity) || isNaN(price_usd) || quantity <= 0 || price_usd < 0) {
                alert('الرجاء إدخال بيانات صحيحة وكاملة.');
                return;
            }
            
            const price_sdg = (price_usd * currentUSD_SDG_Rate).toFixed(2);
            const currentDate = new Date().toLocaleString();

            const data = {
                'id': `ID-${Date.now()}`, // إنشاء ID فريد مؤقت
                'item_id': item_id,
                'name': name,
                'quantity': quantity,
                'price_usd': price_usd.toFixed(2),
                'price_sdg': price_sdg,
                'lastupdatedate': currentDate
            };

            try {
                const response = await fetch(`${API_BASE_URL}?sheet=Inventory`, {
                    method: 'POST',
                    headers: { 'Accept': 'application/json', 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data: data })
                });

                if (response.ok) {
                    alert('تم إضافة قطعة الغيار بنجاح إلى المخزون!');
                    loadInventory(); // تحديث الجدول
                } else {
                    const error = await response.json();
                    alert('فشل في الإضافة: ' + (error.message || response.statusText));
                }
            } catch (error) {
                console.error('خطأ في الإضافة:', error);
                alert('حدث خطأ أثناء الاتصال بالخادم.');
            }
        }

        // **3- وظيفة السحب من المخزون (بيع) (PATCH/POST)**
        async function sellPart() {
            const sell_item_id = document.getElementById('sell_item_id').value;
            const sell_quantity = parseInt(document.getElementById('sell_quantity').value);

            if (!sell_item_id || isNaN(sell_quantity) || sell_quantity <= 0) {
                alert('الرجاء إدخال رقم قطعة وكمية صحيحة للسحب.');
                return;
            }

            // الخطوة 1: البحث عن القطعة في المخزون
            const sheetInventory = 'Inventory';
            const inventoryResponse = await fetch(`${API_BASE_URL}?sheet=${sheetInventory}&search=item_id&item_id=${sell_item_id}`);
            const inventoryData = await inventoryResponse.json();

            if (!inventoryData || inventoryData.length === 0) {
                alert(`القطعة رقم ${sell_item_id} غير موجودة في المخزون.`);
                return;
            }

            const item = inventoryData[0]; // نفترض أن item_id فريد
            const currentQuantity = parseInt(item.quantity);

            if (currentQuantity < sell_quantity) {
                alert(`الكمية المتوفرة (${currentQuantity}) أقل من كمية السحب المطلوبة (${sell_quantity}).`);
                return;
            }

            const newQuantity = currentQuantity - sell_quantity;
            const currentDate = new Date().toLocaleString();
            const price_usd = parseFloat(item.price_usd);
            const price_sdg = (price_usd * currentUSD_SDG_Rate).toFixed(2);

            // الخطوة 2: تحديث كمية المخزون (PATCH)
            try {
                const updateData = {
                    'quantity': newQuantity,
                    'lastupdatedate': currentDate
                };
                
                const updateResponse = await fetch(`${API_BASE_URL}/${sheetInventory}/item_id/${sell_item_id}`, {
                    method: 'PATCH',
                    headers: { 'Accept': 'application/json', 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data: updateData })
                });

                if (!updateResponse.ok) {
                    throw new Error('فشل في تحديث المخزون');
                }
                
                // الخطوة 3: تسجيل العملية في جدول المبيعات (POST)
                const salesData = {
                    'id': `SALE-${Date.now()}`,
                    'item_id': item.item_id,
                    'name': item.name,
                    'quantity': sell_quantity, // الكمية التي تم سحبها (بيعها)
                    'price_usd': price_usd.toFixed(2),
                    'price_sdg': price_sdg,
                    'lastupdatedate': currentDate
                };

                const salesResponse = await fetch(`${API_BASE_URL}?sheet=Sales`, {
                    method: 'POST',
                    headers: { 'Accept': 'application/json', 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data: salesData })
                });

                if (salesResponse.ok) {
                    alert(`تم سحب ${sell_quantity} من القطعة ${item.name} وتسجيلها كمبيعات بنجاح.`);
                    loadInventory(); // تحديث جدول المخزون
                } else {
                    // إذا فشل تسجيل المبيعات، يجب محاولة التراجع عن تحديث المخزون (وهي عملية معقدة)
                    alert('تم تحديث المخزون، لكن فشل تسجيل المبيعات. الرجاء مراجعة البيانات يدوياً.');
                    console.error('فشل تسجيل المبيعات:', await salesResponse.json());
                }

            } catch (error) {
                console.error('خطأ في عملية البيع:', error);
                alert('حدث خطأ أثناء عملية السحب (البيع).');
            }
        }

        // **5- وظيفة إظهار تقرير المبيعات**
        async function showSalesReport() {
            const sheet = 'Sales';
            try {
                const response = await fetch(`${API_BASE_URL}?sheet=${sheet}`);
                const data = await response.json();
                const tableBody = document.querySelector('#salesTable tbody');
                const salesTable = document.getElementById('salesTable');
                tableBody.innerHTML = ''; 
                
                if (data.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="7">لا توجد سجلات مبيعات.</td></tr>';
                    salesTable.style.display = 'table';
                    return;
                }

                let totalSalesUSD = 0;
                let totalSalesSDG = 0;

                data.forEach(item => {
                    const quantity = parseInt(item.quantity);
                    const price_usd = parseFloat(item.price_usd);
                    const price_sdg_item = parseFloat(item.price_sdg);

                    totalSalesUSD += quantity * price_usd;
                    totalSalesSDG += quantity * price_sdg_item;

                    const row = tableBody.insertRow();
                    row.innerHTML = `
                        <td>${item.id}</td>
                        <td>${item.item_id}</td>
                        <td>${item.name}</td>
                        <td>${item.quantity}</td>
                        <td>${price_usd.toFixed(2)}</td>
                        <td>${price_sdg_item.toFixed(2)}</td>
                        <td>${item.lastupdatedate || 'N/A'}</td>
                    `;
                });
                
                // إدراج صف الإجمالي
                const totalRow = tableBody.insertRow();
                totalRow.style.fontWeight = 'bold';
                totalRow.innerHTML = `
                    <td colspan="3">الإجمالي</td>
                    <td></td>
                    <td>${totalSalesUSD.toFixed(2)} USD</td>
                    <td>${totalSalesSDG.toFixed(2)} SDG</td>
                    <td></td>
                `;

                salesTable.style.display = 'table';
            } catch (error) {
                console.error('خطأ في جلب تقرير المبيعات:', error);
                alert('حدث خطأ أثناء جلب تقرير المبيعات.');
            }
        }

        // تحميل المخزون عند بدء تشغيل الصفحة
        document.addEventListener('DOMContentLoaded', loadInventory);
    </script>
</body>
</html>
